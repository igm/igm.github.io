<!doctype html><html lang=en><head><meta charset=utf-8><link rel=stylesheet type=text/css media=screen href=//cdnjs.cloudflare.com/ajax/libs/fancybox/1.3.4/jquery.fancybox-1.3.4.css><link rel=stylesheet href=https://blog.igormihalik.com/css/page.css><title>SockJS for Go III (yet another take)</title></head><body><div class=content><h1>SockJS for Go III (yet another take)</h1><script id=dsq-count-scr src=//igormihalik.disqus.com/count.js async></script><p>It&rsquo;s been a while since the last blog and this is the last in the series of &ldquo;SockJS-go lessons learned&rdquo;.</p><h2 id=version-v2>Version &ldquo;v2&rdquo;</h2><p>&ldquo;v2&rdquo; is a compete rewrite of the SockJS-go library [1], the entire code base is much smaller thanks to using the full potential of Go&rsquo;s <a href=http://godoc.org/net/http target=_blank>net/http</a> library. So no more http &ldquo;hijacks&rdquo; and number of go routines the library spawns internally is kept to minimum. The project also adopted versioning based on <a href=http://labix.org/gopkg.in target=_blank>gopkg.in</a>. The main reason for gopkg.in adoption was that &ldquo;v2&rdquo; uses a different API compared to &ldquo;v1&rdquo;, which was for experimental purposes only. The aim of &ldquo;v2&rdquo; is to become more stable and eventually production ready library. To get the package execute:</p><pre><code>$ go get gopkg.in/igm/sockjs-go.v2/sockjs
</code></pre><p>To import this package, add the following line to your code:</p><pre><code>import &quot;gopkg.in/igm/sockjs-go.v2/sockjs&quot;
</code></pre><h2 id=data-frames>Data frames</h2><p>SockJS was primarily created to enable applications running in older browsers to use WebSocket-like communication with server, or in other words provide <a href=https://github.com/sockjs/sockjs-node target=_blank>WebSocket emulation</a> [2]. It provides a mechanism to send messages (or data frames) in both directions, from client to server and server to client. The only properly supported frames in SockJS are text frames. So in order to send binary data it is solely responsibility of an application to properly encode/decode binary message into text messages using UTF-8 encoding. Just to make the entire picture more complete, WebSockets as defined by RFC6455 support both types of data frames: <a href=http://tools.ietf.org/html/rfc6455#section-5.6 target=_blank>binary and text</a>.</p><h2 id=api-changes>API Changes</h2><p>As described above, SockJS (similar to WebSocket) uses data frames. A client initiates a connection to a server and creates a new sockjs session. Depending on the underlaying transport, the session can span over multiple connections. Thus the notion of sockjs session. This is reflected in the API by <a href=http://godoc.org/github.com/igm/sockjs-go/sockjs#Session target=_blank>sockjs.Session</a> interface. Interface is simple enough to enable receiving and sending text frames, get the session ID and close the session.</p><h2 id=sockjs-protocol-tests>SockJS Protocol Tests</h2><p>This is probably the most questioned part of SockJS for Go implementation. Not all tests pass, and there&rsquo;s no plan to make them pass. However here is the list of tests that do not pass with some explanation:</p><ul><li><b>WebSocket tests</b> protocol tests use hixie-76 and hybi-10 draft implementations of WebSocket protocol. The latest RFC6544 is not covered. There are no plans to implement draft versions in Go (SockJS-go uses <a href=http://www.gorillatoolkit.org/pkg/websocket target=_blank>Gorilla&rsquo;s WebSockets</a> implementation). This also means, that older browsers implementing draft versions will not use WebSocket but will fall back to another transport protocol</li><li><b>JSONEncoding tests</b> use escaping of UTF surrogates to enable binary frames. As Go uses UTF-8 encoding internally for strings, it&rsquo;s advisable to use only valid characters in frames. Any binary encoding/decoding is responsibility of application layer and SockJS-go does not do any escaping.</li><li><b>RawWebsocket tests</b> test raw WebSockets. SockJS-go test server registers handlers for raw WebSocket even if they don&rsquo;t pass (due to above mentioned WebSocket draft protocol reasons). If in your application you plan to use raw WebSockets you can, the net/http package is flexible enough to mix and match various handlers so you can use SockJS-go handler together with any other http handler including WebSocket handlers like <a href=http://godoc.org/code.google.com/p/go.net/websocket target=_blank>this</a> or <a href=http://www.gorillatoolkit.org/pkg/websocket target=_blank>this</a>.</li></ul><h2 id=conclusion>Conclusion</h2><p>Rewriting the SockJS-go library several times (9 or 10 times all together) was a perfect drill to learn Go more in deep. The latest version tries to be as simple as possible. It is also incredible to see the progress of Go since it was first introduced. The language is very much the same, but the libraries and runtime are improving at a fast pace with every release keeping the backward compatibility.</p><h2 id=references>References</h2><ol><li><a href=https://github.com/igm/sockjs-go target=_blank>SockJS-go GitHub repository</a></li></li><li><a href=https://github.com/sockjs/sockjs-node>SockJS-node</a> </li></li></ol><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://blog.igormihalik.com",this.page.identifier="/post/sockjs-for-go-iii-yet-another-take/"};(function(){var a=document,b=a.createElement('script');b.src='//igormihalik.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><script type=text/javascript src=//code.jquery.com/jquery-1.11.0.min.js></script><script type=text/javascript src=//code.jquery.com/jquery-migrate-1.2.1.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/fancybox/1.3.4/jquery.fancybox-1.3.4.pack.min.js></script><script type=text/javascript>$(function(a){var b=!1,c=!0,d='inside';a(b?'img':'img.fancybox').each(function(){var b=a(this),c=b.attr('title'),d=b.attr('data-big')||b.attr('src'),e=a('<a href="#" class="fancybox"></a>').attr('href',d).attr('title',c);b.wrap(e)}),c&&a('a.fancybox').attr('rel','fancyboxgallery'),a('a.fancybox').fancybox({titlePosition:d})}),$.noConflict()</script></body></html>